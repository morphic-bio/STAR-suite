# STAR-suite TODOs

- Validate `--soloAddTagsToUnsorted` behavior (unsorted BAM CB/UB tag injection) for Flex runs; decide whether to fix or remove for core STARsolo.
- Relax CB/UB strict coupling by default for non-Flex runs (keep strict policy for Flex); verify whether Flex drops CB when UB is missing.
- Fix and run remaining smoke tests with missing fixtures for memory leak repair validation.
- Change libflex to use the modular libscrna (EmptyDrops, etc.) instead of vendored copies.
  - When doing this, regression test the new `--crMinUmi` default (10) to ensure it doesn't cause regressions for:
    - FLEX probe sets (likely OK at 10)
    - Lineage barcodes / stable features (may need lower threshold like 2-3)
  - See `docs/TODO_crispr_feature_calling.md` for detailed regression test plan.
  - After regression testing, update the assay-specific recommendations table in:
    - `tests/crispr_feature_calling_comparison_report.md`
    - `docs/feature_barcodes.md`
- [DONE] Remove libcairo dependency from core STAR build by replacing process_features heatmap output with Plotly HTML+JSON.
  - Heatmaps now emit `Feature_counts_heatmap.html` + `.json` and `Feature_types_heatmap.html` + `.json`
  - No external graphics dependencies required; Plotly loaded from CDN at render time
  - Removed `NO_HEATMAP` build flag (no longer needed since there's no external dependency)
- Keep Plotly+JSON QC outputs in process_features and migrate QC graphics into a shared core so other STAR components can reuse them (eventually replace STAR's existing QC graphics with this core).
- Draft a design note for a shared QC graphics core (inputs/outputs, Plotly+JSON artifacts, TSV fallbacks, and how STAR/other components will call it).
- Verify no downstream scripts/tools expect `Feature_types_heatmap.png` or `Feature_counts_heatmap.png`; document the HTML/JSON switch in any user-facing docs if needed.
- Consider adding a read-level consistency preflight for global feature offset detection (warn/error if a large fraction of matches are off the global offset).
