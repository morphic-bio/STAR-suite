# Heatmap Refactor Summary: Cairo to Plotly Migration

**Date:** 2026-01-24  
**Status:** COMPLETED

## Overview

Replaced the `libcairo`-based PNG heatmap generation in `process_features` with Plotly HTML+JSON outputs. This removes the `libcairo` dependency from STAR builds, improving portability and reducing external dependencies.

## Motivation

- `libcairo` was added as a dependency when integrating CRISPR feature calling into STAR's CR-compat mode
- STAR aims to minimize external dependencies for portability across different systems
- Plotly HTML+JSON provides interactive visualizations without compile-time dependencies (Plotly is loaded from CDN at render time)

## Changes Made

### 1. Core Implementation: `heatmap.c`

**Files Modified:**
- `/mnt/pikachu/STAR-suite/core/features/process_features/src/heatmap.c`
- `/mnt/pikachu/process_features/src/heatmap.c` (standalone copy)

**Changes:**
- Completely rewrote from cairo-based PNG generation to Plotly HTML+JSON
- Removed all `#include <cairo.h>` and cairo API calls
- Added JSON export functions for programmatic data access
- Embedded Plasma colorscale directly in JavaScript (no header files needed)
- Preserved existing function signatures (`generate_heatmap`, `generate_deduped_heatmap`)

**New Output Files:**
| Old Output | New Outputs |
|------------|-------------|
| `Feature_counts_heatmap.png` | `Feature_counts_heatmap.html` + `Feature_counts_heatmap.json` |
| `Feature_types_heatmap.png` | `Feature_types_heatmap.html` + `Feature_types_heatmap.json` |

### 2. Build System Updates

**Files Modified:**
- `/mnt/pikachu/STAR-suite/core/features/process_features/Makefile`
- `/mnt/pikachu/STAR-suite/core/legacy/source/Makefile`
- `/mnt/pikachu/process_features/Makefile` (standalone)

**Changes to `process_features/Makefile`:**
```diff
-CAIRO_CFLAGS := $(shell pkg-config --cflags cairo)
-CAIRO_LIBS := $(shell pkg-config --libs cairo)
+# Library flags (no cairo - heatmaps now use Plotly HTML+JSON)

-CFLAGS=... $(CAIRO_CFLAGS) ...
-LDFLAGS=... $(CAIRO_LIBS) ...
+CFLAGS=... (no cairo flags)
+LDFLAGS=... (no cairo libs)
```

**Changes to `core/legacy/source/Makefile`:**
- Removed `-lcairo` from `STAR$(SFX)` target link flags
- Removed `-lcairo` from `gdb` target link flags
- Removed `-lcairo` from `star_feature_call` target link flags

### 3. Removed `NO_HEATMAP` Build Flag

The `NO_HEATMAP=1` build flag was removed entirely since:
- There's no longer an external dependency (cairo) to avoid
- Plotly HTML+JSON has no compile-time dependencies
- Heatmaps are now always generated by default

**Removed from:**
- `core/features/process_features/Makefile` - removed conditional `ifeq ($(NO_HEATMAP), 1)`
- `core/features/feature_barcodes/Makefile` - same removal
- `/mnt/pikachu/process_features/Makefile` - same removal
- `core/features/process_features/src/assignBarcodes.c` - removed `#ifndef NO_HEATMAP` guards
- `core/features/feature_barcodes/src/assignBarcodes.c` - same removal
- `/mnt/pikachu/process_features/src/assignBarcodes.c` - same removal
- `core/features/process_features/README.md` - removed from conditional build flags docs
- `core/features/feature_barcodes/README.md` - same removal
- `core/features/feature_barcodes/flex_demux.md` - removed from prerequisites
- `/mnt/pikachu/process_features/flex_demux.md` - removed from prerequisites

### 4. Deleted Colormap Headers (No Longer Needed)

**From `/mnt/pikachu/STAR-suite/core/features/process_features/include/`:**
- `plasma_colormap.h` (36,908 bytes)
- `plasma_colormap_16.h` (621 bytes)
- `plasma_colormap_64.h` (2,349 bytes)
- `plasma_colormap_256.h` (9,263 bytes)
- `plasma_colormap_1024.h` (36,913 bytes)
- `viridis_colormap.h` (36,909 bytes)

**From `/mnt/pikachu/STAR-suite/core/features/feature_barcodes/include/`:**
- Same 6 colormap header files deleted

**From `/mnt/pikachu/process_features/include/`:**
- Same 6 colormap header files deleted

**Total removed:** ~368 KB of generated colormap data (3 directories Ã— ~123 KB each)

### 5. Documentation Updates

**Files Modified:**
- `/mnt/pikachu/STAR-suite/core/features/process_features/README.md`
- `/mnt/pikachu/STAR-suite/docs/todos`
- `/mnt/pikachu/STAR-suite/plans/heatmap_refactor_plan.md`
- `/mnt/pikachu/process_features/README.md` (standalone)

**README Changes:**
- Removed `libcairo2-dev` from installation instructions
- Updated heatmap output section to describe HTML+JSON format
- Added JSON schema documentation
- Updated library linking examples (removed `-lcairo`)

**TODOs Update:**
- Marked libcairo removal as `[DONE]`

## JSON Data Format

The JSON heatmap data files contain:

```json
{
  "title": "Feature Counts (Deduplicated) Heatmap",
  "feature_labels": ["Feature1", "Feature2", ...],
  "column_labels": [1, 2, 3, ...],
  "column_sums": [100, 50, 25, ...],
  "matrix": [[1, 2, 0], [0, 5, 3], ...],
  "type": "deduped_counts",
  "num_features": 10,
  "num_filtered_features": 8,
  "num_columns": 50
}
```

## HTML Features

The generated HTML files include:
- Interactive Plotly heatmap with Plasma colorscale
- Bar graph showing column totals above the heatmap
- Hover tooltips with feature name, column, and count
- Link to companion JSON data file
- Responsive layout
- Plotly loaded from CDN (`https://cdn.plot.ly/plotly-latest.min.js`)

## Verification

### Functional Test
```bash
cd /mnt/pikachu/STAR-suite/core/features/process_features
./tests/test_assignbarcodes_regression.sh
```

**Result:** `Feature_types_heatmap.html` and `Feature_types_heatmap.json` generated correctly.

Sample JSON output:
```json
{
  "title": "Feature Types (Richness) Heatmap",
  "feature_labels": ["FeatureA", "FeatureC"],
  "column_labels": [1],
  "column_sums": [2],
  "matrix": [[1], [1]],
  "type": "coexpression",
  "num_features": 5,
  "num_filtered_features": 2,
  "num_columns": 1
}
```

HTML output includes:
- Plotly script from CDN
- Bar graph trace for column totals
- Heatmap trace with Plasma colorscale
- Interactive hover templates

Test baseline updated to include new HTML+JSON outputs.

### Build Verification
```bash
# STAR-suite
cd /mnt/pikachu/STAR-suite/core/features/process_features
make clean && make lib  # Success

cd /mnt/pikachu/STAR-suite/core/legacy/source
make STAR  # Success

# Standalone
cd /mnt/pikachu/process_features
make clean && make  # Success
```

### Dependency Verification
```bash
# Confirm no cairo dependency
ldd /mnt/pikachu/STAR-suite/core/legacy/source/STAR | grep cairo
# (no output - success)

ldd /mnt/pikachu/process_features/assignBarcodes | grep cairo
# (no output - success)
```

### STAR Version Check
```bash
/mnt/pikachu/STAR-suite/core/legacy/source/STAR --version
# 2.7.11b
```

## Backward Compatibility

| Aspect | Status |
|--------|--------|
| Function signatures | Unchanged (`generate_heatmap`, `generate_deduped_heatmap`) |
| `--min_heatmap` flag | Still works |
| TSV outputs | Unchanged (emitted elsewhere) |
| Output directory | Same location |

**Breaking Changes:**
1. Output file format changed from PNG to HTML+JSON. Downstream tools expecting `.png` files will need to be updated to use `.html` or `.json` files.
2. `NO_HEATMAP=1` build flag removed (no longer needed since there's no external dependency to avoid). Heatmaps are always generated.

## Files Summary

### Modified Files
1. `/mnt/pikachu/STAR-suite/core/features/process_features/src/heatmap.c`
2. `/mnt/pikachu/STAR-suite/core/features/process_features/src/assignBarcodes.c`
3. `/mnt/pikachu/STAR-suite/core/features/process_features/Makefile`
4. `/mnt/pikachu/STAR-suite/core/features/process_features/README.md`
5. `/mnt/pikachu/STAR-suite/core/features/feature_barcodes/src/heatmap.c`
6. `/mnt/pikachu/STAR-suite/core/features/feature_barcodes/src/assignBarcodes.c`
7. `/mnt/pikachu/STAR-suite/core/features/feature_barcodes/Makefile`
8. `/mnt/pikachu/STAR-suite/core/features/feature_barcodes/README.md`
9. `/mnt/pikachu/STAR-suite/core/features/feature_barcodes/flex_demux.md`
10. `/mnt/pikachu/STAR-suite/core/legacy/source/Makefile`
11. `/mnt/pikachu/STAR-suite/docs/todos`
12. `/mnt/pikachu/STAR-suite/plans/heatmap_refactor_plan.md`
13. `/mnt/pikachu/process_features/src/heatmap.c`
14. `/mnt/pikachu/process_features/src/assignBarcodes.c`
15. `/mnt/pikachu/process_features/Makefile`
16. `/mnt/pikachu/process_features/README.md`
17. `/mnt/pikachu/process_features/flex_demux.md`

### Deleted Files (18 total)

**From `core/features/process_features/include/`:**
- `plasma_colormap.h`, `plasma_colormap_16.h`, `plasma_colormap_64.h`
- `plasma_colormap_256.h`, `plasma_colormap_1024.h`, `viridis_colormap.h`

**From `core/features/feature_barcodes/include/`:**
- Same 6 colormap header files

**From `/mnt/pikachu/process_features/include/`:**
- Same 6 colormap header files

### Created Files
1. `/mnt/pikachu/STAR-suite/docs/HEATMAP_REFACTOR_SUMMARY.md` (this file)

## Future Work

Per `docs/todos`:
- Keep Plotly+JSON QC outputs in process_features and migrate QC graphics into a shared core so other STAR components can reuse them
- Draft a design note for a shared QC graphics core (inputs/outputs, Plotly+JSON artifacts, TSV fallbacks, and how STAR/other components will call it)
